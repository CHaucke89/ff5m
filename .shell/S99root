#!/bin/bash

## General service to control zmod services
##
## Copyright (C) 2025, Alexander K <https://github.com/drA1ex>
## Copyright (C) 2025, Sergei Rozhkov <https://github.com/ghzserg>
##
## This file may be distributed under the terms of the GNU GPLv3 license


if [ -f /tmp/SKIP_ZMOD ] || [ -f /tmp/SKIP_ZMOD_SOFT ]; then
    echo "Buildroot services disabled due to SKIP_ZMOD mode"
    exit 0
fi


source /opt/config/mod/.shell/common.sh


start() {
    if [ ! -f "$NOT_FIRST_LAUNCH_F" ] &&  [ -f "$CUSTOM_BOOT_F" ]; then
        {
            echo "Goodby Flashforge :)"
            kill -9 "$PPID"
        } 2>&1 | logged "/data/logFiles/boot.log"
        
        xzcat /opt/config/mod/splash.img.xz > /dev/fb0
        
        midi_file=$($CFG_SCRIPT $VAR_PATH --get "midi_start" "BattleCity.mid")
        if [ -n "$midi_file" ]; then
            audio midi -m /opt/config/mod_data/midi/$midi_file &
        fi
    fi
    
    echo "Starting Buildroot env..."
    chroot "$MOD" /opt/config/mod/.root/start.sh
    echo "Done"
    
    touch "$NOT_FIRST_LAUNCH_F"
}

stop() {
    echo "Stop Buildroot env..."
    chroot "$MOD" /opt/config/mod/.root/stop.sh
    echo "Done"
}

case "$1" in
    start)
        start
    ;;
    up)
        up
    ;;
    stop)
        stop
    ;;
    restart|reload)
        stop
        
        while kill -0 $(cat "$MOD/run/moonraker.pid") > /dev/null  2>&1; do sleep 1; done
        while kill -0 $(cat "$MOD/run/httpd.pid") > /dev/null  2>&1; do sleep 1; done
        while kill -0 $(cat "$MOD/run/ntpd.pid") > /dev/null  2>&1; do sleep 1; done
        
        up
    ;;
    *)
        echo "Usage: $0 {start|stop|restart|up}"
        exit 1
esac

exit $?
